{% extends "base.html" %}
{% load static %}

{% block title %}{{ p.titulo }}{% endblock %}

{% block content %}
<div class="card rounded-lg p-6 mb-8 shadow-md">
  <h1 class="font-bold text-3xl sm:text-4xl mb-2">{{ p.titulo }}</h1>

  <p class="text-lg sm:text-xl mb-6 muted">
    {{ p.direccion }}{% if p.localidad %}, {{ p.localidad }}{% endif %}{% if p.provincia %}, {{ p.provincia }}{% endif %}{% if p.pais %}, {{ p.pais }}{% endif %}
  </p>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
    <!-- Columna Izquierda: Galería -->
    <div>
      {% if p.imagen_principal %}
        <img id="mainImageDisplay"
             src="{{ p.imagen_principal.url }}"
             alt="{{ p.titulo }}"
             class="w-full h-64 sm:h-80 md:h-96 object-cover rounded border border-[var(--line)] mb-4 cursor-pointer"
             role="button" tabindex="0">
      {% else %}
        <img id="mainImageDisplay"
             src="{% static 'img/placeholder.webp' %}"
             alt="Sin imagen"
             class="w-full h-64 sm:h-80 md:h-96 object-cover rounded border border-[var(--line)] mb-4">
      {% endif %}

      {% with galeria=imagenes|default:p.imagenes.all %}
      {% if galeria or p.imagen_principal %}
        <div id="thumbsGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-4 gap-2">
          {% if p.imagen_principal %}
          <div>
            <img src="{{ p.imagen_principal.url }}"
                 alt="{{ p.titulo }}"
                 class="w-full h-20 sm:h-24 object-cover rounded border border-[var(--line)] cursor-pointer hover:opacity-80 transition">
          </div>
          {% endif %}
          {% for imagen in galeria %}
            <div>
              <img src="{{ imagen.imagen.url }}"
                   alt="{{ imagen.descripcion_corta|default:p.titulo }}"
                   class="w-full h-20 sm:h-24 object-cover rounded border border-[var(--line)] cursor-pointer hover:opacity-80 transition">
            </div>
          {% endfor %}
        </div>
      {% endif %}
      {% endwith %}
    </div>

    <!-- Columna Derecha: Datos -->
    <div>
      {% if p.precio_display %}
        <h2 class="font-semibold text-3xl sm:text-4xl mb-4">{{ p.precio_display }}</h2>
      {% endif %}

      <div class="flex flex-wrap gap-2 mb-6">
        {# Mostrar el tipo sólo si NO es "otro" #}
        {% if p.tipo and p.tipo != 'otro' %}
          <span class="chip">{{ p.get_tipo_display }}</span>
        {% endif %}
        {% if p.tipo_operacion %}
          <span class="chip">{{ p.get_tipo_operacion_display }}</span>
        {% endif %}
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6 text-base">
        {% if p.habitaciones %}<div><strong>Habitaciones:</strong> {{ p.habitaciones }}</div>{% endif %}
        {% if p.banos %}<div><strong>Baños:</strong> {{ p.banos }}</div>{% endif %}
        <div><strong>Cochera:</strong> {% if p.cochera %}Sí{% else %}No{% endif %}</div>
        {% if p.superficie_total %}<div><strong>Sup. Total:</strong> {{ p.superficie_total }} m²</div>{% endif %}
        {% if p.superficie_cubierta %}<div><strong>Sup. Cubierta:</strong> {{ p.superficie_cubierta }} m²</div>{% endif %}
      </div>

      {% if p.descripcion %}
        <h3 class="text-2xl font-bold mb-3">Descripción</h3>
        <!-- .prose asegura que siga tokens en claro/oscuro -->
        <div class="prose max-w-none mt-2">
          {{ p.descripcion|linebreaksbr }}
        </div>
      {% endif %}

      {% with msg="Hola Inmobiliaria, me interesa saber más sobre la propiedad "|add:p.codigo|add:" — "|add:p.titulo|add:" ("|add:p.precio_display|add:")" %}
      <a
        href="https://api.whatsapp.com/send?phone=541168044215&text={{ msg|urlencode }}"
        class="inline-flex items-center justify-center mt-6 px-5 py-3 rounded-lg font-semibold"
        style="background:var(--accent); color:var(--card);"
        target="_blank" rel="noopener"
      >
        Consultar por WhatsApp
      </a>
      {% endwith %}



    </div>
  </div>

  <hr class="my-8" style="border-color:var(--line);" />

  <!-- Sección: solo columnas Dirección + Mapa (sin título general) -->
  <div class="rounded-lg p-6 ubox" style="background:color-mix(in srgb, var(--card) 96%, transparent);">
    <div class="ubox-grid">
      <!-- Columna: Dirección -->
      <section class="ubox-col">
        <h3 class="ubox-h3">Dirección</h3>
        <div class="ubox-body">
          <ul class="list-disc list-inside space-y-2 muted">
            {% if p.direccion %}<li><strong>Dirección:</strong> {{ p.direccion }}</li>{% endif %}
            {% if p.localidad %}<li><strong>Localidad:</strong> {{ p.localidad }}</li>{% endif %}
            {% if p.provincia %}<li><strong>Provincia:</strong> {{ p.provincia }}</li>{% endif %}
            {% if p.pais %}<li><strong>País:</strong> {{ p.pais }}</li>{% endif %}
          </ul>
        </div>
      </section>

      <!-- Columna: Mapa (preferir lat/lng; fallback dirección) -->
<!-- Columna: Mapa (por dirección únicamente) -->
      <section class="ubox-col">
        <h3 class="ubox-h3">Mapa</h3>
        <div class="ubox-body">
          <div
            class="map-frame"
            data-address="{{ p.direccion|default_if_none:'' }}{% if p.localidad %}, {{ p.localidad }}{% endif %}{% if p.provincia %}, {{ p.provincia }}{% endif %}{% if p.pais %}, {{ p.pais }}{% endif %}">
            <iframe title="Mapa de la propiedad" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- Lightbox (encima de todo) -->
<div id="imageLightbox" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4" style="z-index:99999;">
  <div id="imageLightboxBackdrop" class="absolute inset-0"></div>
  <button id="lb-close" class="absolute top-4 right-4 text-white text-4xl leading-none font-bold z-50 p-2">×</button>
  <button id="lb-prev"  class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white rounded-full p-3 z-50">‹</button>
  <img id="lb-img" src="" alt="Imagen ampliada" class="relative max-h-[90vh] max-w-[90vw] object-contain rounded-xl shadow-2xl select-none z-40">
  <button id="lb-next"  class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white rounded-full p-3 z-50">›</button>
</div>
{% endblock %}

{% block extra_js %}
  <script defer src="{% static 'js/detalle.js' %}"></script>
{% endblock %}
