{% extends "base.html" %}
{% load static %}

{% block title %}{{ p.titulo }}{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Galería -->
  <div>
    <img
      src="{% if p.imagen_principal %}{{ p.imagen_principal.url }}{% else %}{% static 'img/placeholder.webp' %}{% endif %}"
      alt="{{ p.titulo }}" class="w-full h-72 object-cover rounded-2xl border border-[var(--line)]">
    {% if imagenes %}
      <div class="mt-2 grid grid-cols-5 gap-2">
        {% for img in imagenes %}
          <img src="{{ img.imagen.url }}" alt="" class="h-20 w-full object-cover rounded-lg border border-[var(--line)]">
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Datos -->
  <div>
    <h1 class="text-2xl font-semibold">{{ p.titulo }}</h1>
    <p class="text-lg muted mt-1">{{ p.precio_display }}</p>

    <div class="mt-3 flex flex-wrap gap-2 text-sm">
      <span class="chip">🛏️ {{ p.habitaciones }} hab.</span>
      <span class="chip">🛁 {{ p.banos }} baño(s)</span>
      {% if p.cochera %}
        <span class="chip">🚗 Cochera</span>
      {% else %}
        <span class="chip">🚗 No posee cochera</span>
      {% endif %}
      {% if p.acepta_mascotas %}
        <span class="chip">🐶 Acepta mascotas</span>
      {% else %}
        <span class="chip">🐶 No acepta mascotas</span>
      {% endif %}
      {% if p.superficie_total %}<span class="chip">📐 {{ p.superficie_total }} m² tot.</span>{% endif %}
      {% if p.superficie_cubierta %}<span class="chip">🏢 {{ p.superficie_cubierta }} m² cub.</span>{% endif %}
    </div>

    <p class="mt-3 text-sm muted">📍 {{ p.direccion }}, {{ p.localidad }}, {{ p.provincia }}, {{ p.pais }}</p>

    <div class="prose max-w-none mt-4">
      <p>{{ p.descripcion|linebreaksbr }}</p>
    </div>
  </div>
</div>

<!-- Mapa -->
{% if p.latitud and p.longitud %}
  <div class="mt-6">
    <h2 class="font-semibold mb-2">Ubicación</h2>
    <div id="map" class="h-80 w-full rounded-2xl border border-[var(--line)]"></div>
  </div>
{% endif %}

<!-- CTA móvil fijo -->
<div class="fixed inset-x-0 bottom-0 z-40 sm:hidden">
  <div class="mx-auto max-w-7xl px-3 pb-3">
    <div class="card shadow p-2 flex gap-2">
      <a class="btn btn-primary flex-1 text-center"
         href="https://wa.me/54TU_NUMERO?text=Consulta%20por%20{{ p.codigo }}">WhatsApp</a>
      <a class="btn flex-1 text-center" href="tel:+54TUNUMERO">Llamar</a>
    </div>
  </div>
</div>

{% block extra_js %}
{% if p.latitud and p.longitud %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    (function(){
      const lat = {{ p.latitud|default:"null" }};
      const lng = {{ p.longitud|default:"null" }};
      if (lat && lng) {
        const map = L.map('map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19, attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        L.marker([lat, lng]).addTo(map).bindPopup("{{ p.titulo|escapejs }}");
      }
    })();
  </script>
{% endif %}
{% endblock %}
{% endblock %}
